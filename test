#!/usr/bin/env bash
# check_load.sh — returns 0 if Tab1 was loaded today, 1 otherwise.

# --- CONFIGURATION ---
# You can override these via env vars or on the command line.
: "${SQL_SERVER:=localhost}"
: "${SQL_DATABASE:=MyDatabase}"
: "${SQL_USER:=sa}"
: "${SQL_PASSWORD:=YourPassword}"
# ----------------------

# Get today's date in YYYY-MM-DD
today=$(date +%F)

# Query SQL Server: get max(load) as YYYY-MM-DD
last_load=$(sqlcmd \
  -S "${SQL_SERVER}" \
  -d "${SQL_DATABASE}" \
  -U "${SQL_USER}" \
  -P "${SQL_PASSWORD}" \
  -h -1 -W \
  -Q "SET NOCOUNT ON;
      SELECT CONVERT(varchar(10), MAX([load]), 120) 
        FROM dbo.Tab1;" \
)

# Trim whitespace
last_load=$(echo "$last_load" | xargs)

if [[ "$last_load" == "$today" ]]; then
  echo "Load is current (last load: $last_load)."
  exit 0
else
  echo "ERROR: Load is not current. Last load was $last_load."
  exit 1
fi
