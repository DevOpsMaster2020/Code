#!/bin/bash

today=$(date +'%Y-%m-%d')  # SQL datetime format
maxCount=7
count=1
to_email="dl-holt-marketdata@ubs.com"
EMAIL_UTIL="/path/to/email_util"  # replace this
SQL_SERVER="your_sql_server"
SQL_DB="your_database"
SQL_USER="your_user"
SQL_PASS="your_password"  # optional if using trusted auth

query="SET NOCOUNT ON; SELECT COUNT(*) FROM ReplicaUpdates WHERE CONVERT(date, last_updated) = '$today';"

while [ $count -lt $maxCount ]; do
    # Run SQL query and capture output
    result=$(sqlcmd -S "$SQL_SERVER" -d "$SQL_DB" -U "$SQL_USER" -P "$SQL_PASS" -h -1 -Q "$query" | tr -d '[:space:]')

    if [ "$result" -gt 0 ]; then
        $EMAIL_UTIL "$to_email" "Daily Dividend Started" "XF NA REPI tables were updated today. So Dai"
        /HOLTPROD_SCRIPTS/dividend/dividend_friday_707_blobber_edm.sh
        break
    else
        sleep 10m
        count=$((count + 1))
    fi
done

if [ "$count" -eq "$maxCount" ]; then
    $EMAIL_UTIL "$to_email" "Daily Dividend Abandoned" "Something is Wrong. The REPL table might not have been updated."
fi
